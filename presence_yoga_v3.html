<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presence ‚Ä¢ Alignment Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="yoga-v3.js"></script>

    <style>
        body { background-color: #fcfcfd; margin: 0; padding: 0; overflow: hidden; }
        .method-btn.active { background-color: #ecfdf5; border-color: #10b981; color: #065f46; font-weight: bold; }
        input[type="range"] { width: 100%; accent-color: #10b981; }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function AlignmentLab() {
            // ===== 1. STATE =====
            const [masterData, setMasterData] = useState([]);
            const [status, setStatus] = useState('connecting');
            const [activeLevel, setActiveLevel] = useState('Beginner');
            const [selectedCategory, setSelectedCategory] = useState('All Categories');
            const [search, setSearch] = useState('');
            const [seq, setSeq] = useState({ flow: [] });
            const [classLimit] = useState(60);

            // ===== 2. DATA CONNECTION =====
            useEffect(() => {
                const checkData = setInterval(() => {
                    // Pulls from your Yoga V3 variables
                    const vault = window.ALL_POSES || window.yogaLibraryVariations;
                    
                    if (vault && vault.length > 0) {
                        setMasterData(vault);
                        setStatus('ready');
                        clearInterval(checkData);
                    }
                }, 500);

                return () => clearInterval(checkData);
            }, []);

            // ===== 3. LOGIC =====
            const filteredList = masterData.filter(p => {
                const matchesLevel = p.level === activeLevel;
                const matchesCat = selectedCategory === 'All Categories' || p.family === selectedCategory;
                const matchesSearch = p.name.toLowerCase().includes(search.toLowerCase());
                return matchesLevel && matchesCat && matchesSearch;
            });

            const addPose = (pose) => {
                const newEntry = { 
                    ...pose, 
                    tempId: Date.now() + Math.random(), 
                    holdType: 'breath', 
                    holdVal: 5 
                };
                setSeq(s => ({ ...s, flow: [...s.flow, newEntry] }));
            };

            const updateItem = (index, field, value) => {
                const newFlow = [...seq.flow];
                newFlow[index][field] = value;
                setSeq({ ...seq, flow: newFlow });
            };

            const removeItem = (index) => {
                setSeq(s => ({ ...s, flow: s.flow.filter((_, i) => i !== index) }));
            };

            // Estimate: 1 breath = 6s, 10 breaths = 1min.
            const estMinutes = Math.round(seq.flow.reduce((acc, item) => {
                return acc + (item.holdType === 'breath' ? (item.holdVal * 0.15) : (item.holdVal / 60));
            }, 0));

            // ===== 4. UI COMPONENTS =====
            if (status === 'connecting') {
                return (
                    <div className="h-screen flex items-center justify-center bg-indigo-50">
                        <div className="text-center">
                            <div className="w-10 h-10 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="font-serif text-indigo-900">Syncing Biometric Vault...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen bg-white font-sans text-slate-900">
                    {/* SIDEBAR: POSE SELECTOR */}
                    <aside className="w-80 border-r border-slate-100 flex flex-col p-6">
                        <h1 className="font-serif text-2xl mb-6 text-emerald-900">presence ‚Ä¢ lab</h1>
                        
                        <div className="space-y-4 pt-4 border-t">
                            <div className="flex bg-slate-100 p-1 rounded-xl">
                                {['Beginner', 'Intermediate', 'Advanced'].map(lvl => (
                                    <button 
                                        key={lvl} 
                                        onClick={() => setActiveLevel(lvl)} 
                                        className={`flex-1 py-1.5 text-[10px] rounded-lg transition-all ${activeLevel === lvl ? 'bg-white shadow-sm font-bold text-emerald-600' : 'text-slate-400 hover:text-slate-600'}`}
                                    >
                                        {lvl}
                                    </button>
                                ))}
                            </div>

                            <select 
                                className="w-full p-2 border border-slate-200 rounded-xl text-xs outline-none focus:border-emerald-300" 
                                value={selectedCategory} 
                                onChange={e => setSelectedCategory(e.target.value)}
                            >
                                {["All Categories", "Standing", "Floor", "Core", "Backbend", "Forward Fold", "Inversion", "Restorative"].map(c => (
                                    <option key={c} value={c}>{c}</option>
                                ))}
                            </select>

                            <input 
                                type="text" 
                                placeholder="Search library..." 
                                className="w-full p-2 text-sm italic border-b border-slate-100 outline-none focus:border-emerald-400" 
                                onChange={e => setSearch(e.target.value)} 
                            />

                            <div className="sidebar-scroll space-y-2 pt-2 overflow-y-auto max-h-[calc(100vh-350px)]">
                                {filteredList.length > 0 ? filteredList.map(p => (
                                    <div 
                                        key={p.id} 
                                        onClick={() => addPose(p)} 
                                        className="group flex justify-between items-center p-2 rounded-lg cursor-pointer hover:bg-emerald-50 transition-colors"
                                    >
                                        <div className="flex flex-col">
                                            <span className="text-sm font-medium text-slate-700 group-hover:text-emerald-700">{p.name}</span>
                                            <span className="text-[10px] text-slate-400 italic">{p.sanskrit}</span>
                                        </div>
                                        <span className="text-slate-300 group-hover:text-emerald-500 font-bold">+</span>
                                    </div>
                                )) : <p className="text-center text-xs text-slate-400 pt-4">No poses found in this filter.</p>}
                            </div>
                        </div>
                    </aside>

                    {/* MAIN CONTENT: SEQUENCE BUILDER */}
                    <main className="flex-1 overflow-y-auto p-12 bg-[#fafafa]">
                        <div className="max-w-2xl mx-auto space-y-8">
                            <div className="flex justify-between items-end pb-6 border-b border-slate-200">
                                <div>
                                    <h2 className="font-serif text-4xl text-slate-800 font-bold tracking-tight">Sequence Builder</h2>
                                    <p className="text-slate-400 text-sm mt-1">Design your flow by clicking poses on the left.</p>
                                </div>
                                <div className="p-4 bg-emerald-50 border border-emerald-100 rounded-2xl text-center min-w-[140px]">
                                    <p className="text-[10px] font-bold uppercase text-emerald-600 tracking-widest">Est. Time</p>
                                    <p className="text-2xl font-serif font-bold text-emerald-900">{estMinutes} min</p>
                                </div>
                            </div>

                            <div className="space-y-4">
                                {seq.flow.length === 0 && (
                                    <div className="py-20 text-center border-2 border-dashed border-slate-200 rounded-[3rem]">
                                        <p className="text-slate-300 font-serif text-xl italic">Empty Canvas</p>
                                    </div>
                                )}

                                {seq.flow.map((item, i) => (
                                    <div key={item.tempId} className="bg-white rounded-[2rem] p-8 shadow-sm border border-slate-200 hover:border-emerald-200 transition-all">
                                        <div className="flex justify-between items-center mb-6">
                                            <div>
                                                <span className="text-[10px] font-bold text-emerald-500 uppercase tracking-tighter bg-emerald-50 px-2 py-1 rounded-md mr-2">{item.family}</span>
                                                <h3 className="inline font-serif text-2xl text-slate-800">{i+1}. {item.name}</h3>
                                            </div>
                                            <button onClick={() => removeItem(i)} className="text-slate-300 hover:text-red-400 transition-colors">‚úï</button>
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-10">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Hold Mode</label>
                                                <div className="flex gap-2 mt-2">
                                                    <button 
                                                        onClick={() => updateItem(i, 'holdType', 'breath')} 
                                                        className={`flex-1 py-2 text-xs rounded-xl border transition-all ${item.holdType === 'breath' ? 'bg-emerald-50 border-emerald-200 text-emerald-700 font-bold' : 'bg-white border-slate-100 text-slate-400'}`}
                                                    >
                                                        üå¨Ô∏è Breath
                                                    </button>
                                                    <button 
                                                        onClick={() => updateItem(i, 'holdType', 'time')} 
                                                        className={`flex-1 py-2 text-xs rounded-xl border transition-all ${item.holdType === 'time' ? 'bg-blue-50 border-blue-200 text-blue-700 font-bold' : 'bg-white border-slate-100 text-slate-400'}`}
                                                    >
                                                        ‚è±Ô∏è Timed
                                                    </button>
                                                </div>
                                            </div>
                                            <div>
                                                <div className="flex justify-between text-[10px] font-bold uppercase tracking-widest">
                                                    <label className="text-slate-400">Duration</label>
                                                    <span className="text-emerald-700">{item.holdVal} {item.holdType === 'breath' ? 'Breaths' : 'Sec'}</span>
                                                </div>
                                                <input 
                                                    type="range" 
                                                    className="mt-3" 
                                                    min={item.holdType === 'breath' ? "1" : "5"} 
                                                    max={item.holdType === 'breath' ? "20" : "180"} 
                                                    value={item.holdVal} 
                                                    onChange={e => updateItem(i, 'holdVal', parseInt(e.target.value))} 
                                                />
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AlignmentLab />);
    </script>
</body>
</html>
