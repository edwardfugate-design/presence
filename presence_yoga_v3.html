<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presence • Yoga Studio</title>
    
    <script src="pose-database.js"></script>
    <script src="yoga-library-with-variations.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --studio-bg: #f8f9f8;
            --studio-card: #ffffff;
            --studio-accent: #064e3b;
            --text-main: #1a1a1a;
        }
        body.dark-mode {
            --studio-bg: #121412;
            --studio-card: #1c1e1c;
            --studio-accent: #10b981;
            --text-main: #f3f4f6;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--studio-bg);
            color: var(--text-main);
            transition: all 0.3s ease;
        }
        .font-serif { font-family: 'Cormorant Garamond', serif; }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
        .pose-card:hover { transform: translateY(-2px); border-color: var(--studio-accent); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ICONS ---
        const Search = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>;
        const Plus = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const Trash = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;

        // --- DATA ENGINE ---
        const getMasterLibrary = () => {
            const sources = [
                window.yogaLibraryData, 
                window.POSE_DATABASE, 
                window.POSE_LIBRARY,
                window.allPoses
            ].filter(Boolean);

            let flattened = {};
            sources.forEach(source => {
                if (Array.isArray(source)) {
                    source.forEach(pose => {
                        const id = pose.id || (pose.name ? pose.name.toLowerCase().replace(/\s+/g, '-') : Math.random());
                        flattened[id] = pose;
                    });
                } else if (source.categories) {
                    source.categories.forEach(cat => {
                        cat.poses?.forEach(pose => {
                            const id = pose.id || (pose.name ? pose.name.toLowerCase().replace(/\s+/g, '-') : Math.random());
                            flattened[id] = { ...pose, categoryName: cat.name };
                        });
                    });
                }
            });
            return flattened;
        };

        function App() {
            const [library, setLibrary] = useState({});
            const [searchTerm, setSearchTerm] = useState('');
            const [sequence, setSequence] = useState({ warmup: [], flow: [], peak: [], floor: [] });
            const [isDark, setIsDark] = useState(false);

            // Auto-load data even if files are slow
            useEffect(() => {
                const load = () => {
                    const data = getMasterLibrary();
                    if (Object.keys(data).length > 0) setLibrary(data);
                };
                load();
                const timer = setInterval(load, 1000);
                return () => clearInterval(timer);
            }, []);

            const filteredPoses = useMemo(() => {
                return Object.values(library).filter(p => 
                    p.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    p.sanskrit?.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [searchTerm, library]);

            const addPose = (id, section) => {
                setSequence(prev => ({ ...prev, [section]: [...prev[section], id] }));
            };

            const removePose = (section, index) => {
                setSequence(prev => ({
                    ...prev,
                    [section]: prev[section].filter((_, i) => i !== index)
                }));
            };

            const syncToRituals = () => {
                const saved = JSON.parse(localStorage.getItem('presence_rituals') || '[]');
                const ritual = {
                    id: Date.now(),
                    name: `Yoga Flow: ${new Date().toLocaleDateString()}`,
                    time: "morning",
                    steps: ["yoga"],
                    sequenceData: sequence
                };
                localStorage.setItem('presence_rituals', JSON.stringify([...saved, ritual]));
                alert("✨ Sequence saved to your Rituals app!");
            };

            return (
                <div className={isDark ? "dark-mode" : ""}>
                    {/* Header */}
                    <header className="h-16 border-b flex items-center justify-between px-8 bg-[var(--studio-card)]">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-emerald-800 rounded-full flex items-center justify-center text-white font-bold text-sm">P</div>
                            <h1 className="font-serif text-2xl tracking-tight">Presence Studio</h1>
                        </div>
                        <div className="flex gap-4">
                            <button onClick={() => setIsDark(!isDark)} className="text-xs uppercase tracking-widest opacity-50">
                                {isDark ? "Light Mode" : "Dark Mode"}
                            </button>
                        </div>
                    </header>

                    <div className="flex h-[calc(100vh-64px)] overflow-hidden">
                        {/* Sidebar: Library */}
                        <aside className="w-80 border-r bg-[var(--studio-card)] flex flex-col">
                            <div className="p-4 border-b">
                                <div className="relative">
                                    <span className="absolute left-3 top-2.5 opacity-30"><Search /></span>
                                    <input 
                                        type="text" 
                                        placeholder="Search 500+ poses..." 
                                        className="w-full bg-[var(--studio-bg)] border rounded-full py-2 pl-10 pr-4 text-sm focus:outline-none focus:border-emerald-500"
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-2 sidebar-scroll">
                                <p className="text-[10px] uppercase tracking-widest opacity-40 mb-4">Master Library ({filteredPoses.length})</p>
                                {filteredPoses.map((pose, i) => (
                                    <div key={pose.id || i} className="pose-card p-3 border rounded-xl bg-[var(--studio-bg)] transition-all cursor-default group">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <div className="text-sm font-medium">{pose.name}</div>
                                                <div className="text-[10px] opacity-50 italic">{pose.sanskrit}</div>
                                            </div>
                                            <button 
                                                onClick={() => addPose(pose.id, 'flow')}
                                                className="opacity-0 group-hover:opacity-100 p-1 bg-emerald-600 text-white rounded-md transition-all"
                                            >
                                                <Plus />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                                {filteredPoses.length === 0 && <p className="text-center text-sm opacity-50 py-10">Searching for poses...</p>}
                            </div>
                        </aside>

                        {/* Main Stage: Sequence Builder */}
                        <main className="flex-1 overflow-y-auto p-12 bg-[var(--studio-bg)]">
                            <div className="max-w-2xl mx-auto space-y-12">
                                {Object.entries({ warmup: "Centering & Warm-up", flow: "Main Flow", peak: "Peak Posture", floor: "Cool Down & Savasana" }).map(([key, label]) => (
                                    <section key={key}>
                                        <h3 className="text-[10px] uppercase tracking-[0.2em] text-emerald-600 font-bold mb-6">{label}</h3>
                                        <div className="space-y-3 min-h-[60px] border-l-2 border-emerald-100 ml-2 pl-6">
                                            {sequence[key].map((poseId, idx) => (
                                                <div key={idx} className="flex items-center justify-between p-4 bg-[var(--studio-card)] rounded-2xl shadow-sm border border-transparent hover:border-emerald-200">
                                                    <span className="font-serif text-lg">{library[poseId]?.name || "Unknown Pose"}</span>
                                                    <button onClick={() => removePose(key, idx)} className="text-red-400 hover:text-red-600"><Trash /></button>
                                                </div>
                                            ))}
                                            <div className="text-[10px] opacity-30 italic">Drag poses here from the library</div>
                                        </div>
                                    </section>
                                ))}
                            </div>
                        </main>

                        {/* Actions Panel */}
                        <aside className="w-64 border-l bg-[var(--studio-card)] p-6">
                            <h4 className="font-serif text-xl mb-6">Finalize Flow</h4>
                            <button 
                                onClick={syncToRituals}
                                className="w-full py-4 bg-emerald-900 text-white rounded-2xl text-xs uppercase tracking-widest font-bold hover:bg-emerald-800 transition-all shadow-lg"
                            >
                                Sync to Rituals App
                            </button>
                            <p className="mt-4 text-[10px] opacity-40 leading-relaxed">
                                This will send your sequence to the Rituals App "Presence Rituals" vault.
                            </p>
                        </aside>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
