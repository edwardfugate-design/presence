<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Presence Yoga - AI Sequencing Studio</title>
    
    <script src="yoga-library-with-variations.js"></script>
    <script src="pose-database.js"></script>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif; overflow-x: hidden; transition: background-color 0.4s ease, color 0.4s ease; }
    .font-serif { font-family: 'Cormorant Garamond', serif; }
    .dark-mode { background-color: #0f1110; color: #e5e7eb; }
    .light-mode { background-color: #fcfaf7; color: #1f2937; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: rgba(120, 113, 108, 0.1); border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(120, 113, 108, 0.3); border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(120, 113, 108, 0.5); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
    .animate-shimmer { animation: shimmer 2s infinite linear; background: linear-gradient(to right, transparent 0%, rgba(16, 185, 129, 0.2) 50%, transparent 100%); background-size: 1000px 100%; }
  </style>
</head>
<body class="light-mode">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    
    // ICON COMPONENTS
    const ChevronDown = ({ size = 24, className = '' }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 12 15 18 9"></polyline></svg>);
    const Plus = ({ size = 24, className = '' }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>);
    const X = ({ size = 24, className = '' }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
    const Search = ({ size = 24, className = '' }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>);
    const Sparkles = ({ size = 24, className = '' }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>);
    const Wand2 = ({ size = 24, className = '' }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"></path><path d="m14 7 3 3"></path><path d="M5 6v4"></path><path d="M19 14v4"></path><path d="M10 2v2"></path><path d="M7 8H3"></path><path d="M21 16h-4"></path><path d="M11 3H9"></path></svg>);
    const Download = ({ size = 24, className = '' }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>);
    const Moon = ({ size = 24, className = '' }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>);
    const Sun = ({ size = 24, className = '' }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>);

    // BRIDGE TO EXTERNAL LIBRARIES
    // This allows the app to use either of your database files automatically
    const getMasterLibrary = () => {
        const lib = window.yogaLibraryData || window.POSE_LIBRARY || window.POSE_DATABASE || {};
        // If it's the POSE_DATABASE format, flatten categories for the search logic
        if (window.POSE_DATABASE && !window.yogaLibraryData) {
            return Object.values(window.POSE_DATABASE).flat().reduce((acc, pose) => {
                acc[pose.id] = pose;
                return acc;
            }, {});
        }
        return lib;
    };

    function PresenceYoga() {
      const [theme, setTheme] = useState('light');
      const [selectedLevel, setSelectedLevel] = useState('Beginner');
      const [duration, setDuration] = useState(60);
      const [searchTerm, setSearchTerm] = useState('');
      const [isGenerating, setIsGenerating] = useState(false);
      const [viewMode, setViewMode] = useState('structural');
      const [library, setLibrary] = useState({});
      
      const [sequence, setSequence] = useState({
        warmup: [],
        standing: [],
        peak: [],
        cooldown: [],
        savasana: []
      });

      // Load external data on mount
      useEffect(() => {
        const loadData = () => {
            const master = getMasterLibrary();
            setLibrary(master);
            // Default Savasana
            if (master.savasana || master.corpse) {
                setSequence(s => ({...s, savasana: [master.savasana ? 'savasana' : 'corpse']}));
            }
        };
        // Small delay to ensure scripts are executed
        setTimeout(loadData, 500);
      }, []);

      useEffect(() => {
        document.body.className = theme === 'dark' ? 'dark-mode font-serif' : 'light-mode font-serif';
      }, [theme]);

      const toggleTheme = () => setTheme(prev => prev === 'light' ? 'dark' : 'light');

      const sectionNames = {
        warmup: 'Warm-Up & Grounding',
        standing: 'Standing & Flow',
        peak: 'Peak Postures',
        cooldown: 'Cool Down & Release',
        savasana: 'Savasana & Integration'
      };

      // SEARCH LOGIC: Handles the huge nested library
      const filteredPoses = useMemo(() => {
        return Object.values(library).filter(pose =>
          pose.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
          pose.sanskrit?.toLowerCase().includes(searchTerm.toLowerCase()) ||
          pose.family?.toLowerCase().includes(searchTerm.toLowerCase())
        );
      }, [searchTerm, library]);

      const generateSequence = async () => {
        setIsGenerating(true);
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Dynamic generation based on what actually exists in your library
        const ids = Object.keys(library);
        const getRandom = (fam) => ids.filter(id => library[id].family === fam || library[id].category === fam);

        setSequence({
          warmup: [ids.find(id => id.includes('child')) || ids[0]],
          standing: [ids.find(id => id.includes('warrior')) || ids[1], ids.find(id => id.includes('triangle')) || ids[2]],
          peak: [ids.find(id => id.includes('wheel')) || ids.find(id => id.includes('bridge')) || ids[3]],
          cooldown: [ids.find(id => id.includes('twist')) || ids[4]],
          savasana: [ids.find(id => id.includes('savasana')) || ids.find(id => id.includes('corpse')) || ids[5]]
        });
        setIsGenerating(false);
      };

      const addPoseToSection = (poseId, section) => {
        setSequence(prev => ({ ...prev, [section]: [...prev[section], poseId] }));
      };

      const removePoseFromSection = (poseId, section, index) => {
        setSequence(prev => ({ ...prev, [section]: prev[section].filter((_, idx) => idx !== index) }));
      };

      const totalDuration = useMemo(() => {
        let total = 0;
        Object.values(sequence).forEach(section => {
          section.forEach(id => { if (library[id]) total += (library[id].duration || 30); });
        });
        return Math.round(total / 60);
      }, [sequence, library]);

      return (
        <div className="min-h-screen">
          <header className={`border-b px-8 py-6 sticky top-0 z-50 transition-colors ${theme === 'dark' ? 'bg-[#161817] border-white/10' : 'bg-white border-gray-100'}`}>
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${theme === 'dark' ? 'bg-emerald-500 text-black' : 'bg-emerald-950 text-white'}`}>P</div>
                <div>
                  <h1 className="text-3xl font-light font-serif tracking-tight">Presence Yoga</h1>
                  <p className={`text-sm mt-1 ${theme === 'dark' ? 'text-stone-500' : 'text-gray-600'}`}>Professional Studio v3.2</p>
                </div>
              </div>
              <div className="flex items-center gap-6">
                <button onClick={toggleTheme} className={`p-2 rounded-full transition-colors ${theme === 'dark' ? 'bg-white/5 text-yellow-400' : 'bg-gray-100 text-gray-500'}`}>
                  {theme === 'light' ? <Moon size={20} /> : <Sun size={20} />}
                </button>
                <div className="text-right">
                  <div className="text-sm opacity-60">Total Duration</div>
                  <div className="text-2xl font-light">{totalDuration} min</div>
                </div>
              </div>
            </div>
          </header>

          <div className="grid grid-cols-12 h-[calc(100vh-97px)]">
            <aside className={`col-span-3 border-r p-6 overflow-y-auto custom-scrollbar ${theme === 'dark' ? 'bg-[#0f1110] border-white/5' : 'bg-white border-gray-100'}`}>
              <div className="mb-6">
                <h2 className="text-xs uppercase tracking-widest mb-4 opacity-50">AI Controls</h2>
                <div className="mb-4">
                    <label className="block text-xs mb-2 opacity-60">Intensity Level</label>
                    <div className="flex gap-1">
                        {['Beginner', 'Intermediate', 'Advanced'].map(l => (
                            <button key={l} onClick={() => setSelectedLevel(l)} className={`flex-1 py-2 text-[10px] rounded border ${selectedLevel === l ? 'bg-emerald-500/20 border-emerald-500' : 'border-transparent opacity-40'}`}>{l}</button>
                        ))}
                    </div>
                </div>
                <button onClick={generateSequence} disabled={isGenerating} className="w-full py-3 bg-emerald-600 text-white rounded-lg flex items-center justify-center gap-2 hover:bg-emerald-500 transition-all shadow-lg">
                  {isGenerating ? <div className="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full" /> : <Sparkles size={18} />}
                  <span>Auto-Sequence</span>
                </button>
              </div>

              <div className="mt-8">
                <h3 className="text-xs uppercase tracking-widest mb-4 opacity-50">Pose Library ({Object.keys(library).length})</h3>
                <div className="relative mb-4">
                  <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 opacity-30" />
                  <input type="text" placeholder="Filter library..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className={`w-full border rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none ${theme === 'dark' ? 'bg-stone-900 border-stone-800' : 'bg-gray-50 border-gray-200'}`} />
                </div>
                <div className="space-y-2 max-h-[500px] overflow-y-auto custom-scrollbar pr-2">
                  {filteredPoses.slice(0, 100).map(pose => (
                    <div key={pose.id} className={`p-3 rounded-lg border cursor-pointer hover:scale-[1.02] transition-all ${theme === 'dark' ? 'bg-stone-900/40 border-stone-800/50' : 'bg-gray-50 border-gray-200'}`} onClick={() => addPoseToSection(pose.id, 'standing')}>
                      <div className="text-sm font-medium">{pose.name}</div>
                      <div className="text-[10px] opacity-40 italic">{pose.sanskrit}</div>
                    </div>
                  ))}
                </div>
              </div>
            </aside>
            
            <main className={`col-span-6 p-8 overflow-y-auto custom-scrollbar ${theme === 'dark' ? 'bg-[#0a0c0b]' : 'bg-[#fcfaf7]'}`}>
              <div className="flex justify-between items-center mb-8">
                <h2 className="text-2xl font-light">Sequence Flow</h2>
                <div className="flex bg-black/5 p-1 rounded-lg">
                    {['structural', 'teaching'].map(v => (
                        <button key={v} onClick={() => setViewMode(v)} className={`px-4 py-1.5 text-xs rounded-md capitalize ${viewMode === v ? 'bg-white shadow-sm' : 'opacity-40'}`}>{v}</button>
                    ))}
                </div>
              </div>

              <div className="space-y-12">
                {Object.entries(sequence).map(([section, poses]) => (
                  <div key={section} className="relative">
                    <h3 className="text-sm uppercase tracking-[0.2em] mb-4 text-emerald-600 font-bold">{sectionNames[section]}</h3>
                    <div className="space-y-3 pl-4 border-l border-emerald-500/20">
                      {poses.map((id, idx) => {
                        const p = library[id];
                        if (!p) return null;
                        return (
                          <div key={`${id}-${idx}`} className={`flex items-center justify-between p-4 rounded-xl shadow-sm border ${theme === 'dark' ? 'bg-stone-900/40 border-stone-800' : 'bg-white border-gray-100'}`}>
                            <div>
                                <div className="font-medium">{p.name}</div>
                                <div className="text-xs opacity-40">{p.sanskrit} â€¢ {p.duration || 30}s</div>
                            </div>
                            <button onClick={() => removePoseFromSection(id, section, idx)} className="opacity-20 hover:opacity-100 hover:text-red-500"><X size={16}/></button>
                          </div>
                        );
                      })}
                      <button onClick={() => document.querySelector('input').focus()} className="w-full py-3 border-2 border-dashed border-black/5 rounded-xl text-xs opacity-30 hover:opacity-100 transition-opacity">+ Add from library</button>
                    </div>
                  </div>
                ))}
              </div>
            </main>
            
            <aside className={`col-span-3 border-l p-6 ${theme === 'dark' ? 'bg-[#0f1110] border-white/5' : 'bg-white border-gray-100'}`}>
                <h2 className="text-xs uppercase tracking-widest mb-6 opacity-50">Intelligence</h2>
                <div className="p-4 rounded-xl bg-indigo-500/5 border border-indigo-500/10 mb-6">
                    <div className="text-[10px] text-indigo-400 uppercase mb-2">Health Score</div>
                    <div className="h-1.5 w-full bg-black/5 rounded-full overflow-hidden">
                        <div className="h-full bg-emerald-500" style={{width: '85%'}}></div>
                    </div>
                    <p className="text-[11px] mt-3 opacity-60">This sequence features a balanced mix of lateral stretches and inversions.</p>
                </div>
                <button className="w-full py-3 border border-emerald-500/30 text-emerald-500 rounded-lg text-sm hover:bg-emerald-500 hover:text-white transition-all">Export PDF</button>
            </aside>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<PresenceYoga />);
  </script>
</body>
</html>
