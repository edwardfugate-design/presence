<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presence • Yoga Studio v3</title>
    
    <script src="pose-database.js"></script>
    <script src="yoga-library-with-variations.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --studio-bg: #fdfdfc;
            --studio-card: #ffffff;
            --studio-accent: #064e3b;
            --text-main: #1a1a1a;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--studio-bg);
            color: var(--text-main);
            margin: 0;
        }
        .font-serif { font-family: 'Cormorant Garamond', serif; }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
        .pose-card { transition: all 0.2s ease; border: 1px solid #eee; }
        .pose-card:hover { border-color: #064e3b; background: #f0fdf4; transform: translateX(4px); }
        .section-drop { min-height: 80px; border-left: 2px solid #ecfdf5; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ICONS ---
        const Search = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>;
        const Plus = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const Trash = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;

        function App() {
            const [library, setLibrary] = useState({});
            const [searchTerm, setSearchTerm] = useState('');
            const [sequence, setSequence] = useState({ warmup: [], standing: [], peak: [], floor: [], savasana: [] });

            // DATA ENGINE: Specifically tuned for your POSE_LIBRARY + Variations structure
            const getMasterLibrary = () => {
                // Priority 1: Use the pre-flattened variations list
                const variations = window.yogaLibraryVariations || window.allPoses || window.ALL_POSES;
                
                if (variations && Array.isArray(variations)) {
                    const flattened = {};
                    variations.forEach(pose => {
                        const id = pose.id || pose.name?.toLowerCase().replace(/\s+/g, '-');
                        flattened[id] = pose;
                    });
                    return flattened;
                }

                // Priority 2: Use the object structure (standing, seated, etc.)
                const rawDB = window.yogaLibraryData || window.POSE_LIBRARY || window.POSE_DATABASE || window.poseDatabase;
                if (rawDB) {
                    const flattened = {};
                    Object.keys(rawDB).forEach(key => {
                        const content = rawDB[key];
                        // If it's the structure with nested variation objects
                        if (content && content.name && content.id) {
                            flattened[content.id] = content;
                            if (content.variations) {
                                content.variations.forEach(v => {
                                    flattened[v.id] = { ...v, family: content.family, isVariation: true };
                                });
                            }
                        } 
                        // If it's the structure with arrays (standing: [...])
                        else if (Array.isArray(content)) {
                            content.forEach(pose => {
                                const id = pose.id || pose.name?.toLowerCase().replace(/\s+/g, '-');
                                flattened[id] = { ...pose, categoryName: key };
                            });
                        }
                    });
                    return flattened;
                }
                return {};
            };

            useEffect(() => {
                const load = () => {
                    const data = getMasterLibrary();
                    if (Object.keys(data).length > 0) setLibrary(data);
                };
                load();
                const timer = setInterval(load, 1500); // Check every 1.5s for slow-loading JS files
                return () => clearInterval(timer);
            }, []);

            const filteredPoses = useMemo(() => {
                return Object.values(library).filter(p => 
                    p.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    p.sanskrit?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    p.family?.toLowerCase().includes(searchTerm.toLowerCase())
                ).sort((a, b) => (a.name > b.name ? 1 : -1));
            }, [searchTerm, library]);

            const addPose = (id, section) => {
                setSequence(prev => ({ ...prev, [section]: [...prev[section], id] }));
            };

            const removePose = (section, index) => {
                setSequence(prev => ({
                    ...prev,
                    [section]: prev[section].filter((_, i) => i !== index)
                }));
            };

            const syncToRituals = () => {
                const saved = JSON.parse(localStorage.getItem('presence_rituals') || '[]');
                const ritual = {
                    id: Date.now(),
                    name: `Yoga: ${new Date().toLocaleDateString()}`,
                    time: "morning",
                    steps: ["yoga"],
                    sequenceData: sequence
                };
                localStorage.setItem('presence_rituals', JSON.stringify([...saved, ritual]));
                alert("✨ Sequence synced to your Rituals App!");
            };

            return (
                <div className="flex flex-col h-screen overflow-hidden">
                    {/* Header */}
                    <header className="h-16 border-b flex items-center justify-between px-8 bg-white z-10 shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-emerald-900 rounded-full flex items-center justify-center text-white font-bold text-xs">P</div>
                            <h1 className="font-serif text-2xl tracking-tight">Presence Studio <span className="text-xs font-sans opacity-40 ml-2">v3.1</span></h1>
                        </div>
                        <button 
                            onClick={syncToRituals}
                            className="bg-emerald-900 text-white px-6 py-2 rounded-full text-xs uppercase tracking-widest hover:bg-emerald-800 transition-colors"
                        >
                            Sync to Rituals
                        </button>
                    </header>

                    <div className="flex flex-1 overflow-hidden">
                        {/* Sidebar: Library */}
                        <aside className="w-80 border-r bg-white flex flex-col">
                            <div className="p-4 border-b space-y-4">
                                <div className="relative">
                                    <span className="absolute left-3 top-2.5 opacity-30"><Search /></span>
                                    <input 
                                        type="text" 
                                        placeholder="Search 500+ poses..." 
                                        className="w-full bg-gray-50 border border-gray-100 rounded-lg py-2 pl-10 pr-4 text-sm focus:outline-none focus:border-emerald-500"
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-2 sidebar-scroll">
                                <p className="text-[10px] uppercase tracking-widest opacity-40 mb-2">Vault Results ({filteredPoses.length})</p>
                                {filteredPoses.map((pose) => (
                                    <div key={pose.id} className="pose-card p-3 rounded-xl bg-white cursor-default group">
                                        <div className="flex justify-between items-start">
                                            <div className="overflow-hidden">
                                                <div className="text-sm font-medium truncate">{pose.name}</div>
                                                <div className="text-[10px] opacity-50 italic truncate">{pose.sanskrit}</div>
                                                <div className="flex gap-1 mt-1">
                                                    <span className="text-[8px] bg-gray-100 px-1 rounded uppercase tracking-tighter opacity-60">{pose.family}</span>
                                                    {pose.isVariation && <span className="text-[8px] bg-blue-50 text-blue-600 px-1 rounded uppercase tracking-tighter">Variation</span>}
                                                </div>
                                            </div>
                                            <div className="flex flex-col gap-1">
                                                <button onClick={() => addPose(pose.id, 'standing')} className="p-1 hover:bg-emerald-50 rounded text-emerald-700"><Plus /></button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {filteredPoses.length === 0 && (
                                    <div className="text-center py-20">
                                        <div className="animate-pulse text-sm opacity-30 italic">Searching Vault...</div>
                                    </div>
                                )}
                            </div>
                        </aside>

                        {/* Main Stage */}
                        <main className="flex-1 overflow-y-auto p-12 bg-gray-50/50 sidebar-scroll">
                            <div className="max-w-2xl mx-auto space-y-10">
                                {Object.entries({ 
                                    warmup: "Centering & Warm-up", 
                                    standing: "Main Standing Flow", 
                                    peak: "Peak Posture", 
                                    floor: "Floor Work", 
                                    savasana: "Closing" 
                                }).map(([key, label]) => (
                                    <section key={key} className="group">
                                        <h3 className="text-[10px] uppercase tracking-[0.2em] text-emerald-700 font-bold mb-4 opacity-60">{label}</h3>
                                        <div className="section-drop ml-1 pl-6 space-y-3">
                                            {sequence[key].map((poseId, idx) => (
                                                <div key={`${poseId}-${idx}`} className="flex items-center justify-between p-4 bg-white rounded-xl shadow-sm border border-white hover:border-emerald-200 transition-all">
                                                    <div className="flex flex-col">
                                                        <span className="font-serif text-lg leading-tight">{library[poseId]?.name}</span>
                                                        <span className="text-[10px] opacity-40 uppercase tracking-widest">{library[poseId]?.family}</span>
                                                    </div>
                                                    <button onClick={() => removePose(key, idx)} className="text-gray-300 hover:text-red-400 transition-colors"><Trash /></button>
                                                </div>
                                            ))}
                                            {sequence[key].length === 0 && (
                                                <div className="text-[11px] text-gray-400 font-light italic py-2">Click + on a pose to add to this section</div>
                                            )}
                                        </div>
                                    </section>
                                ))}
                            </div>
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
