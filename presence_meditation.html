/**
 * PRESENCE MEDITATION - FULL RESTORATION
 * Logic for 15 paths and dynamic breathing techniques.
 */

const PresenceApp = {
    // Every path exactly as defined in your original template
    paths: [
        'mindfulness', 'heart', 'foundational', 'energizing', 'cooling', 
        'balancing', 'advanced', 'somatic', 'concentration', 'visualization', 
        'devotional', 'zen', 'nondual', 'movement', 'insight'
    ],

    state: {
        totalPracticeMinutes: parseFloat(localStorage.getItem('totalPracticeMinutes') || '0'),
        breathingActive: false,
        currentPath: 'mindfulness',
        currentTechnique: null,
        audioContext: null
    },

    init() {
        this.render();
        this.updateTotalHours();
        this.selectPath('mindfulness'); // Default startup path
    },

    render() {
        const container = document.getElementById('meditation-app');
        if (!container) return;

        container.innerHTML = `
            <div class="presence-container">
                <div class="title">presence</div>
                <div class="subtitle">you have arrived at this moment.</div>

                <div class="stats-bar">
                    <span id="totalHours">0.0</span> hours present
                </div>

                <div class="button-controls">
                    <div class="button-group">
                        <div class="button-group-label">1. choose your path</div>
                        <div class="button-row" id="path-buttons">
                            ${this.paths.map(p => `
                                <button class="choice-btn" id="btn-${p}" onclick="PresenceApp.selectPath('${p}')">${p}</button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="button-group">
                        <div class="button-group-label">2. choose breathing technique</div>
                        <select id="techniqueSelect" onchange="PresenceApp.handleTechniqueChange()"></select>
                    </div>
                </div>

                <div class="breath-circle" id="breathCircle" onclick="PresenceApp.toggleBreathing()">
                    <div id="breathLabel" class="breath-label">tap to begin</div>
                </div>

                <div id="bellNotification" class="bell-notification">
                    <div class="bell-text">stop. breathe. notice. this moment is enough.</div>
                </div>
            </div>
        `;
    },

    // RESTORED: Filters techniques by the selected path
    selectPath(path) {
        this.state.currentPath = path;
        document.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.getElementById(`btn-${path}`);
        if (activeBtn) activeBtn.classList.add('active');

        // This links to your presence-content-manager.js logic
        if (window.ContentManager) {
            const techniques = window.ContentManager.getTechniquesByPath(path);
            const select = document.getElementById('techniqueSelect');
            select.innerHTML = techniques.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            this.handleTechniqueChange();
        }
    },

    handleTechniqueChange() {
        const id = document.getElementById('techniqueSelect').value;
        if (window.ContentManager) {
            this.state.currentTechnique = window.ContentManager.getTechniqueById(id);
            this.resetBreathing();
        }
    },

    toggleBreathing() {
        const circle = document.getElementById('breathCircle');
        const label = document.getElementById('breathLabel');
        this.state.breathingActive = !this.state.breathingActive;

        if (this.state.breathingActive) {
            circle.classList.add('breathing', 'inhale');
            label.innerText = "inhale";
            this.playBell(440); // Original sine-wave frequency
        } else {
            circle.classList.remove('breathing', 'inhale');
            label.innerText = "tap to resume";
        }
    },

    resetBreathing() {
        const circle = document.getElementById('breathCircle');
        this.state.breathingActive = false;
        circle.classList.remove('breathing', 'inhale');
        document.getElementById('breathLabel').innerText = "tap to begin";
    },

    playBell(freq) {
        if (!this.state.audioContext) this.state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const ctx = this.state.audioContext;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'sine';
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 4);
        osc.start();
        osc.stop(ctx.currentTime + 4);

        const bell = document.getElementById('bellNotification');
        bell.classList.add('show');
        setTimeout(() => bell.classList.remove('show'), 4000);
    },

    updateTotalHours() {
        const hours = (this.state.totalPracticeMinutes / 60).toFixed(1);
        const el = document.getElementById('totalHours');
        if (el) el.textContent = hours;
    }
};

PresenceApp.init();
