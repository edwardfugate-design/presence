/**
 * SYMPHONY RESTORATION: PRESENCE MEDITATION
 * Features: 15 Mindfulness Paths + Restored Breathing + New Timer Logic
 */

const SymphonyPresence = {
    state: {
        totalPracticeMinutes: parseFloat(localStorage.getItem('totalPracticeMinutes') || '0'),
        breathingActive: false,
        currentPath: 'mindfulness',
        currentTechnique: null,
        sessionLength: 0, // 0 = Open
        timerRemaining: 0,
        audioContext: null
    },

    // All 15 original paths preserved
    paths: [
        'mindfulness', 'heart', 'foundational', 'energizing', 'cooling', 
        'balancing', 'advanced', 'somatic', 'concentration', 'visualization', 
        'devotional', 'zen', 'nondual', 'movement', 'insight'
    ],

    init() {
        this.render();
        this.updateTotalHours();
        this.selectPath('mindfulness'); // Default startup path
    },

    render() {
        const container = document.getElementById('meditation-app');
        if (!container) return;

        container.innerHTML = `
            <div class="presence-container">
                <div class="title">presence</div>
                <div class="subtitle">you have arrived at this moment.</div>

                <div class="stats-bar">
                    <span id="totalHours">0.0</span> hours present
                </div>

                <div class="button-controls">
                    <div class="button-group">
                        <div class="button-group-label">1. choose your path</div>
                        <div class="button-row" id="path-buttons">
                            ${this.paths.map(p => `
                                <button class="choice-btn" id="btn-${p}" onclick="SymphonyPresence.selectPath('${p}')">${p}</button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="button-group">
                        <div class="button-group-label">2. choose breathing technique</div>
                        <select id="techniqueSelect" onchange="SymphonyPresence.handleTechniqueChange()"></select>
                    </div>

                    <div class="button-group">
                        <div class="button-group-label">3. set duration (minutes)</div>
                        <div class="preset-group">
                            <button class="preset-btn" onclick="SymphonyPresence.setTimer(5)">5</button>
                            <button class="preset-btn" onclick="SymphonyPresence.setTimer(10)">10</button>
                            <button class="preset-btn" onclick="SymphonyPresence.setTimer(15)">15</button>
                            <button class="preset-btn" onclick="SymphonyPresence.setTimer(30)">30</button>
                            <button class="preset-btn" onclick="SymphonyPresence.setTimer(60)">60</button>
                            <button class="preset-btn" onclick="SymphonyPresence.setTimer('random')">random</button>
                            <button class="preset-btn" onclick="SymphonyPresence.setTimer(0)">open</button>
                        </div>
                    </div>
                </div>

                <div class="breath-circle" id="breathCircle" onclick="SymphonyPresence.toggleBreathing()">
                    <div id="breathLabel" class="breath-label">tap to begin</div>
                </div>

                <div class="timer-display" id="timerDisplay">â€”</div>
            </div>
        `;
    },

    setTimer(minutes) {
        if (minutes === 'random') {
            const options = [5, 10, 15, 30, 60];
            this.state.sessionLength = options[Math.floor(Math.random() * options.length)];
        } else {
            this.state.sessionLength = minutes;
        }
        
        this.state.timerRemaining = this.state.sessionLength * 60;
        this.updateTimerUI();
        
        // Visual feedback for selected button
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.classList.toggle('active', btn.innerText.toLowerCase() === minutes.toString().toLowerCase());
        });
    },

    updateTimerUI() {
        const el = document.getElementById('timerDisplay');
        if (this.state.sessionLength === 0) {
            el.innerText = "open session";
        } else {
            const mins = Math.floor(this.state.timerRemaining / 60);
            const secs = this.state.timerRemaining % 60;
            el.innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    },

    selectPath(path) {
        this.state.currentPath = path;
        document.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.getElementById(`btn-${path}`);
        if (activeBtn) activeBtn.classList.add('active');

        // Dynamically fetch techniques from the Content Manager
        if (window.ContentManager) {
            const techniques = window.ContentManager.getTechniquesByPath(path);
            const select = document.getElementById('techniqueSelect');
            select.innerHTML = techniques.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            this.handleTechniqueChange();
        }
    },

    handleTechniqueChange() {
        const id = document.getElementById('techniqueSelect').value;
        if (window.ContentManager) {
            this.state.currentTechnique = window.ContentManager.getTechniqueById(id);
            this.resetBreathing();
        }
    },

    toggleBreathing() {
        this.state.breathingActive = !this.state.breathingActive;
        const circle = document.getElementById('breathCircle');
        const label = document.getElementById('breathLabel');

        if (this.state.breathingActive) {
            circle.classList.add('breathing');
            label.innerText = "inhale";
            this.startTimerInterval();
        } else {
            circle.classList.remove('breathing');
            label.innerText = "tap to resume";
            clearInterval(this.timerInterval);
        }
    },

    startTimerInterval() {
        clearInterval(this.timerInterval);
        this.timerInterval = setInterval(() => {
            if (this.state.sessionLength > 0 && this.state.timerRemaining > 0) {
                this.state.timerRemaining--;
                this.updateTimerUI();
                if (this.state.timerRemaining <= 0) {
                    this.toggleBreathing();
                    alert("Session complete.");
                }
            }
        }, 1000);
    },

    resetBreathing() {
        this.state.breathingActive = false;
        document.getElementById('breathCircle').classList.remove('breathing');
        document.getElementById('breathLabel').innerText = "tap to begin";
        clearInterval(this.timerInterval);
    },

    updateTotalHours() {
        const hours = (this.state.totalPracticeMinutes / 60).toFixed(1);
        const el = document.getElementById('totalHours');
        if (el) el.textContent = hours;
    }
};

SymphonyPresence.init();
