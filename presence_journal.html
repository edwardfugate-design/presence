<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f8f9fa">
    <title>presence ‚Ä¢ journal</title>
    <script src="presence-symphony-v2.js"></script>
    <script src="presence-content-manager.js"></script>
    <script src="presence-monitoring.js"></script>
    <script src="presence-auto-integrate.js"></script>
    <script src="all-libraries-compact.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --dawn-start: #f8f9fa; --dawn-mid: #e9ecef; --dawn-end: #dee2e6;
            --text-whisper: #6c757d; --text-soft: #495057; --text-present: #212529;
        }
        * { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
        input, textarea { -webkit-user-select: text; user-select: text; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, var(--dawn-start) 0%, var(--dawn-mid) 50%, var(--dawn-end) 100%);
            min-height: 100vh; min-height: -webkit-fill-available; color: var(--text-soft);
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        html { height: -webkit-fill-available; }
        .font-serif { font-family: 'Cormorant Garamond', serif; }
        .stat-label { font-size: 0.7rem; letter-spacing: 0.3em; text-transform: uppercase; color: var(--text-whisper); }
        .entry-card {
            background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.05);
            backdrop-filter: blur(10px); transition: all 0.3s ease;
        }
        @media (hover: hover) {
            .entry-card:hover { background: rgba(255,255,255,0.8); transform: translateY(-2px); }
        }
        .mood-dot {
            width: 44px; height: 44px; border-radius: 50%;
            transition: all 0.3s; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .mood-dot:active { transform: scale(1.1); }
        .presence-slider {
            -webkit-appearance: none; appearance: none; width: 100%; height: 44px;
            background: transparent; outline: none;
        }
        .presence-slider::-webkit-slider-track { height: 4px; background: rgba(0,0,0,0.1); border-radius: 10px; }
        .presence-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 28px; height: 28px;
            background: var(--text-present); cursor: pointer; border-radius: 50%; margin-top: -12px;
        }
        .presence-slider::-moz-range-thumb {
            width: 28px; height: 28px; background: var(--text-present); cursor: pointer; border-radius: 50%; border: none;
        }
        textarea, input { font-size: 16px !important; }
        @media (max-width: 640px) { .mobile-title { font-size: 3rem !important; } }
    </style>
</head>
<body class="p-4 sm:p-8 md:p-16">
    <div class="max-w-4xl mx-auto">
        <header class="mb-8 sm:mb-16">
            <a href="index.html" class="stat-label text-indigo-400 mb-4 block min-h-[44px] flex items-center">‚Üê Hub</a>
            <h1 class="font-serif text-5xl sm:text-7xl tracking-tighter text-gray-900 mb-4 mobile-title">Journal</h1>
            <p class="text-base sm:text-lg text-gray-500 font-light">Capture the residue of practice</p>
        </header>

        <div class="entry-card p-6 sm:p-8 md:p-12 rounded-[2rem] sm:rounded-[2.5rem] mb-8 sm:mb-12">
            <div class="stat-label mb-6">New Entry</div>
            <div class="mb-8">
                <label class="block text-sm mb-3 text-gray-600">How do you feel?</label>
                <div class="flex gap-2 sm:gap-4 justify-between">
                    <div class="mood-dot" style="background: #ef4444;" onclick="setMood(1)" data-mood="1"></div>
                    <div class="mood-dot" style="background: #f59e0b;" onclick="setMood(2)" data-mood="2"></div>
                    <div class="mood-dot" style="background: #fbbf24;" onclick="setMood(3)" data-mood="3"></div>
                    <div class="mood-dot" style="background: #84cc16;" onclick="setMood(4)" data-mood="4"></div>
                    <div class="mood-dot" style="background: #22c55e;" onclick="setMood(5)" data-mood="5"></div>
                </div>
            </div>
            <div class="mb-8">
                <label class="block text-sm mb-3 text-gray-600">How present were you?</label>
                <input type="range" min="1" max="10" value="5" class="presence-slider" id="presenceSlider">
                <div class="flex justify-between text-xs text-gray-400 mt-2">
                    <span>Scattered</span>
                    <span id="presenceValue" class="font-bold text-gray-600">5</span>
                    <span>Fully Present</span>
                </div>
            </div>
            <div class="mb-8">
                <label class="block text-sm mb-3 text-gray-600">What arose?</label>
                <textarea id="notes" rows="6"
                    class="w-full p-4 sm:p-6 rounded-2xl sm:rounded-3xl border border-gray-200 focus:border-gray-400 focus:outline-none resize-none bg-white/50 font-serif text-base sm:text-lg"
                    placeholder="Thoughts, sensations, insights..."></textarea>
            </div>
            <button onclick="saveEntry()"
                class="w-full py-4 rounded-full bg-gray-900 text-white text-xs sm:text-sm uppercase tracking-widest hover:bg-gray-800 transition-all min-h-[48px] active:scale-98">
                Preserve
            </button>
        </div>

        <div class="stat-label mb-6">Timeline</div>
        <div id="timeline" class="space-y-3 sm:space-y-4"></div>
    </div>

    <script>
        let currentMood = 3;
        let currentPresence = 5;

        const presenceSlider = document.getElementById('presenceSlider');
        const presenceValue = document.getElementById('presenceValue');

        presenceSlider.oninput = function() {
            currentPresence = this.value;
            presenceValue.textContent = this.value;
        };

        function setMood(level) {
            currentMood = level;
            if ('vibrate' in navigator) navigator.vibrate(10);
            document.querySelectorAll('.mood-dot').forEach(dot => {
                dot.style.opacity = dot.dataset.mood == level ? '1' : '0.3';
                dot.style.transform = dot.dataset.mood == level ? 'scale(1.1)' : 'scale(1)';
            });
        }

        // üéµ SYMPHONY: Detect practice source with intent/sequence awareness
        function detectSource() {
            // Check for active Symphony intent
            const intent = localStorage.getItem('presence_current_intent');
            if (intent) {
                const intentNames = {
                    'unwind': 'Unwinding', 'arrive': 'Arrival',
                    'sustain': 'Sustaining', 'recover': 'Recovery', 'mark': 'Completion'
                };
                return intentNames[intent] || 'Practice';
            }

            // Check for active sequence
            const sequenceData = localStorage.getItem('presence_current_sequence');
            if (sequenceData) {
                try {
                    const sequence = JSON.parse(sequenceData);
                    return sequence.name || 'Sequence';
                } catch (e) {}
            }

            // Legacy signals
            const signals = {
                still: localStorage.getItem('presence_still') === 'true',
                flow: localStorage.getItem('presence_flow') === 'true',
                ritual: localStorage.getItem('presence_ritual') === 'true'
            };
            if (signals.still) return 'Meditation';
            if (signals.flow) return 'Yoga';
            if (signals.ritual) return 'Ritual';
            return 'Reflection';
        }

        function saveEntry() {
            const notes = document.getElementById('notes').value;
            if (!notes.trim()) { alert('Please write something first'); return; }
            if ('vibrate' in navigator) navigator.vibrate(20);

            // üéµ SYMPHONY: Capture practice context
            let practiceDetails = null;
            const sequenceData = localStorage.getItem('presence_current_sequence');
            if (sequenceData) {
                try {
                    const sequence = JSON.parse(sequenceData);
                    practiceDetails = {
                        sequence: sequence.name,
                        poses: sequence.poses,
                        breathwork: sequence.breathwork,
                        duration: Math.floor((sequence.duration || 0) / 60)
                    };
                } catch (e) {}
            }

            const entry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                mood: currentMood,
                presence: currentPresence,
                notes: notes,
                source: detectSource(),
                practice: practiceDetails  // üéµ Full practice context
            };

            const entries = JSON.parse(localStorage.getItem('presence_journal') || '[]');
            entries.unshift(entry);
            localStorage.setItem('presence_journal', JSON.stringify(entries));

            document.getElementById('notes').value = '';
            setMood(3);
            presenceSlider.value = 5;
            presenceValue.textContent = 5;
            renderTimeline();
        }

        function renderTimeline() {
            const entries = JSON.parse(localStorage.getItem('presence_journal') || '[]');
            const timeline = document.getElementById('timeline');

            if (entries.length === 0) {
                timeline.innerHTML = '<p class="text-center text-gray-400 py-12 font-serif text-base sm:text-lg">No entries yet. Begin your journey.</p>';
                return;
            }

            const moodColors = ['#ef4444', '#f59e0b', '#fbbf24', '#84cc16', '#22c55e'];

            timeline.innerHTML = entries.map(entry => {
                const date = new Date(entry.timestamp);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

                // üéµ Show practice context if available
                let practiceInfo = `${entry.source} ‚Ä¢ Presence: ${entry.presence}/10`;
                if (entry.practice?.duration) practiceInfo += ` ‚Ä¢ ${entry.practice.duration} min`;

                const practiceRow = entry.practice
                    ? `<div class="text-xs text-gray-400 mt-1">${entry.practice.sequence || ''}</div>`
                    : '';

                return `
                    <div class="entry-card p-4 sm:p-6 rounded-2xl sm:rounded-3xl">
                        <div class="flex items-start justify-between mb-3 sm:mb-4">
                            <div>
                                <div class="stat-label mb-1">${dateStr} ‚Ä¢ ${timeStr}</div>
                                <div class="text-xs text-gray-500">${practiceInfo}</div>
                                ${practiceRow}
                            </div>
                            <div class="mood-dot" style="background: ${moodColors[entry.mood - 1]}; width: 24px; height: 24px; flex-shrink: 0;"></div>
                        </div>
                        <p class="font-serif text-base sm:text-lg leading-relaxed text-gray-700">${entry.notes}</p>
                    </div>
                `;
            }).join('');
        }

        function setVH() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        setVH();
        window.addEventListener('resize', setVH);
        window.addEventListener('orientationchange', setVH);

        setMood(3);
        renderTimeline();
    </script>
</body>
</html>
