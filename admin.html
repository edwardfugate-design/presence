<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Presence Admin | Auto-Sync</title>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 40px; color: #2c3e50; }
        .card { max-width: 600px; margin: auto; background: white; padding: 30px; border-radius: 12px; shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { background: #27ae60; color: white; border: none; cursor: pointer; font-weight: bold; }
        .token-box { background: #fff3cd; padding: 15px; border-radius: 6px; font-size: 0.9em; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="card">
    <h2>Vault Auto-Updater</h2>
    
    <div class="token-box">
        <strong>Auth Required:</strong><br>
        <input type="password" id="ghToken" placeholder="Paste GitHub Personal Access Token here...">
    </div>

    <form id="poseForm">
        <input type="text" id="name" placeholder="Pose Name" required>
        <input type="text" id="sanskrit" placeholder="Sanskrit Name">
        <select id="category">
            <option value="standing">Standing</option>
            <option value="seated">Seated</option>
            <option value="backbends">Backbends</option>
            <option value="inversions">Inversions</option>
            <option value="restorative">Restorative</option>
        </select>
        <select id="level">
            <option value="Beginner">Beginner</option>
            <option value="Intermediate">Intermediate</option>
            <option value="Advanced">Advanced</option>
        </select>
        <input type="text" id="muscles" placeholder="Muscles (comma separated)">
        
        <button type="button" onclick="pushToGitHub()">Add to Vault & Update Live Site</button>
    </form>
    <p id="status" style="text-align: center; font-weight: bold;"></p>
</div>

<script>
async function pushToGitHub() {
    const token = document.getElementById('ghToken').value;
    const status = document.getElementById('status');
    
    if (!token) { alert("Please enter your GitHub Token"); return; }

    status.innerText = "Connecting to GitHub...";
    status.style.color = "blue";

    const REPO = "edwardfugate-design/presence";
    const PATH = "presence-vault.js"; // Make sure this matches your filename exactly
    
    try {
        // 1. Fetch the current file from GitHub
        const getUrl = `https://api.github.com/repos/${REPO}/contents/${PATH}`;
        const response = await fetch(getUrl, {
            headers: { 'Authorization': `token ${token}` }
        });
        const fileData = await response.json();
        const sha = fileData.sha;
        
        // 2. Decode the old content
        let content = decodeURIComponent(escape(atob(fileData.content)));

        // 3. Prepare the new pose data
        const newPose = {
            id: Date.now(),
            name: document.getElementById('name').value,
            sanskrit: document.getElementById('sanskrit').value,
            category: document.getElementById('category').value,
            level: document.getElementById('level').value,
            muscles: document.getElementById('muscles').value.split(',').map(m => m.trim())
        };

        // 4. Inject the new pose into the POSE_DATABASE object in the string
        // This looks for the category array and pushes the new pose inside it
        const searchKey = `${newPose.category}: [`;
        const injectionPoint = content.indexOf(searchKey) + searchKey.length;
        const newEntry = `\n        ${JSON.stringify(newPose, null, 8).replace(/}$/, '        },')}`;
        
        const updatedContent = content.slice(0, injectionPoint) + newEntry + content.slice(injectionPoint);

        // 5. Send it back to GitHub
        const updateResponse = await fetch(getUrl, {
            method: 'PUT',
            headers: { 
                'Authorization': `token ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `Admin: Added ${newPose.name} to Vault`,
                content: btoa(unescape(encodeURIComponent(updatedContent))),
                sha: sha
            })
        });

        if (updateResponse.ok) {
            status.innerText = "Success! Site updated.";
            status.style.color = "green";
            document.getElementById('poseForm').reset();
        } else {
            throw new Error("Failed to update file.");
        }

    } catch (err) {
        status.innerText = "Error: Check token or filename.";
        status.style.color = "red";
        console.error(err);
    }
}
</script>
</body>
</html>
