<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Presence ¬∑ Ambient</title>
    <style>
        body { background: #fdfcfb; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; overflow-x: hidden; touch-action: manipulation; color: #1a1a1a; }
        .font-serif { font-family: 'Cormorant Garamond', serif; }
        .aura-field { filter: blur(120px); transition: all 6s ease-in-out; position: fixed; inset: -10%; width: 120%; height: 120%; z-index: -1; opacity: 0.5; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .loading-screen { position: fixed; inset: 0; background: #fdfcfb; display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 1; transition: opacity 0.3s ease-out; }
        .loading-screen.hidden { opacity: 0; pointer-events: none; }
        .min-h-screen { min-height: 100vh; }
        .p-6 { padding: 1.5rem; }
        .max-w-5xl { max-width: 64rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .pb-40 { padding-bottom: 10rem; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .gap-4 { gap: 1rem; }
        .gap-8 { gap: 2rem; }
        .justify-between { justify-content: space-between; }
        .mb-16 { margin-bottom: 4rem; }
        .text-6xl { font-size: 3.75rem; line-height: 1; }
        .italic { font-style: italic; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .rounded-full { border-radius: 9999px; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .fixed { position: fixed; }
        .bottom-10 { bottom: 2.5rem; }
        
        @media (min-width: 640px) { .sm:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); } .md:p-12 { padding: 3rem; } .md:flex-row { flex-direction: row; } }
        @media (min-width: 1024px) { .lg:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
        
        /* Debug Toast */
        #debug-log { position: fixed; top: 10px; right: 10px; font-size: 10px; color: red; background: white; padding: 5px; z-index: 10000; pointer-events: none; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
    <div id="debug-log"></div>
    <div class="loading-screen" id="loadingScreen">
        <div style="text-align: center;">
            <p style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.5;">Presence</p>
        </div>
    </div>
    
    <div id="root"></div>

    <script>
        const log = (msg) => { document.getElementById('debug-log').innerText = msg; console.log(msg); };

        const MASTER_LIBRARY = {
            "üåßÔ∏è Weather": [
                { id: 'rain', n: 'Rainfall', urls: ['https://cdn.freesound.org/previews/344/344430_5121236-lq.mp3'] },
                { id: 'thunder', n: 'Thunder', urls: ['https://cdn.freesound.org/previews/162/162476_2394245-lq.mp3'] }
            ],
            "üåä Water": [
                { id: 'ocean', n: 'Ocean Waves', urls: ['https://cdn.freesound.org/previews/180/180493_3283808-lq.mp3'] }
            ],
            "üî• Fire": [
                { id: 'fire', n: 'Campfire', urls: ['https://cdn.freesound.org/previews/320/320321_527080-lq.mp3'] }
            ]
        };

        const AudioEngine = {
            ctx: null,
            activeLayers: new Map(), // soundId -> HTMLAudioElement

            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            },

            toggle(soundId) {
                this.init();
                
                if (this.activeLayers.has(soundId)) {
                    const audio = this.activeLayers.get(soundId);
                    audio.pause();
                    this.activeLayers.delete(soundId);
                    log(`Stopped: ${soundId}`);
                } else {
                    const sound = Object.values(MASTER_LIBRARY).flat().find(s => s.id === soundId);
                    const audio = new Audio(sound.urls[0]);
                    audio.loop = true;
                    audio.crossOrigin = "anonymous";
                    
                    // The "Non-Looping" secret: random start time
                    audio.addEventListener('loadedmetadata', () => {
                        audio.currentTime = Math.random() * audio.duration;
                    });

                    const playPromise = audio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(_ => {
                            this.activeLayers.set(soundId, audio);
                            log(`Playing: ${soundId}`);
                        }).catch(e => {
                            log(`Error: Click again to unlock audio.`);
                        });
                    }
                }
            },

            stopAll() {
                this.activeLayers.forEach(audio => audio.pause());
                this.activeLayers.clear();
            }
        };

        let state = { category: "üåßÔ∏è Weather", activeIds: [], signal: 'Neutral' };

        function render() {
            const root = document.getElementById('root');
            const auraColor = state.signal === 'Focus' ? '#fef3c7' : state.signal === 'Rest' ? '#dbeafe' : '#e0e7ff';
            
            root.innerHTML = `
                <div class="min-h-screen p-6 md:p-12 max-w-5xl mx-auto pb-40">
                    <div class="aura-field" style="background: ${auraColor};"></div>
                    
                    <header class="flex flex-col md:flex-row justify-between items-start mb-16 gap-8">
                        <div>
                            <h1 class="text-6xl font-serif italic" style="font-weight: 200;">presence</h1>
                            <p style="font-size: 0.625rem; text-transform: uppercase; letter-spacing: 0.4em; opacity: 0.3; margin-top: 1rem;">Layered Ambient Spaces</p>
                        </div>
                    </header>

                    <nav class="flex gap-8 mb-12 overflow-x-auto hide-scrollbar" style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                        ${Object.keys(MASTER_LIBRARY).map(c => `
                            <button onclick="setCategory('${c}')" style="padding-bottom: 1.25rem; font-size: 0.688rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.2em; white-space: nowrap; border:none; background:none; ${state.category === c ? 'border-bottom: 2px solid black; opacity: 1;' : 'opacity: 0.2;'}">${c}</button>
                        `).join('')}
                    </nav>

                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                        ${MASTER_LIBRARY[state.category].map(s => {
                            const isActive = state.activeIds.includes(s.id);
                            return `
                            <button onclick="handleToggle('${s.id}')" style="padding: 1.5rem; border-radius: 2rem; border:none; text-align: left; transition: all 0.4s; height: 8rem; display: flex; flex-direction: column; justify-content: space-between; cursor:pointer; ${isActive ? 'background: white; box-shadow: 0 20px 40px rgba(0,0,0,0.1);' : 'background: rgba(255,255,255,0.4);'}">
                                <div style="width: 0.5rem; height: 0.5rem; border-radius: 9999px; ${isActive ? 'background: #6366f1;' : 'background: rgba(0,0,0,0.1);'}"></div>
                                <div>
                                    <h3 style="font-size: 0.875rem; font-weight: 600;">${s.n}</h3>
                                    <p style="font-size: 0.563rem; opacity: 0.3; text-transform: uppercase;">${isActive ? 'Active' : 'Tap to Mix'}</p>
                                </div>
                            </button>
                        `}).join('')}
                    </div>

                    ${state.activeIds.length > 0 ? `
                        <div class="fixed bottom-10" style="left: 50%; transform: translateX(-50%); width: 90%; max-width: 28rem; background: rgba(255,255,255,0.95); backdrop-filter: blur(40px); padding: 1.5rem; border-radius: 2.5rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="font-weight: 500; font-size: 0.875rem;">${state.activeIds.length} Layers Active</p>
                            </div>
                            <button onclick="handleStopAll()" style="background: black; color: white; padding: 0.75rem 2rem; border-radius: 9999px; font-size: 0.625rem; font-weight: 700; text-transform: uppercase; border:none; cursor:pointer;">Clear All</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function setCategory(cat) { state.category = cat; render(); }
        
        function handleToggle(id) {
            if (state.activeIds.includes(id)) {
                state.activeIds = state.activeIds.filter(i => i !== id);
            } else {
                state.activeIds.push(id);
            }
            AudioEngine.toggle(id);
            render();
        }

        function handleStopAll() {
            AudioEngine.stopAll();
            state.activeIds = [];
            render();
        }

        window.addEventListener('DOMContentLoaded', () => {
            render();
            setTimeout(() => document.getElementById('loadingScreen').classList.add('hidden'), 500);
        });
    </script>
</body>
</html>
